# AGENTS.md

## Verifying correctness of ported code

The "regress" directory contains tmux's own tests. We verify the correctness of ported code by running these tests and comparing C and Rust code output:

```sh
# Build the Rust binary
cargo build --release

# Run the tests and save the output
cd regress
# Use timeout with -k to prevent hanging tests from blocking the coding agent.
TEST_TMUX=(realpath ../target/release/tmux-rs) timeout -k 30 420 make -i 2>&1 | tee test_result_rust

# Compare the output
diff -u ../../tmux/regress/test_result_c test_result_rust
```

Only the following differences are expected. Others indicating potential issues.

```diff
--- ../../tmux/regress/test_result_c	2025-08-08 12:27:52
+++ test_result_rust	2025-08-20 13:17:50
@@ -1,7 +1,7 @@
 sh am-terminal.sh
 sleep 1
 sh capture-pane-hyperlink.sh
-/var/folders/c9/hs7776l50t32_6dz7csp4h780000gn/T/tmp.MuA3fCdYu2 /var/folders/c9/hs7776l50t32_6dz7csp4h780000gn/T/tmp.mtUXfLzYvf differ: char 1, line 1
+/var/folders/c9/hs7776l50t32_6dz7csp4h780000gn/T/tmp.TdELM1II2N /var/folders/c9/hs7776l50t32_6dz7csp4h780000gn/T/tmp.z8IjUDwnzV differ: char 1, line 1
 make: [capture-pane-hyperlink.sh] Error 1 (ignored)
 sleep 1
 sh capture-pane-sgr0.sh
@@ -17,7 +17,6 @@
 sh control-client-size.sh
 sleep 1
 sh copy-mode-test-emacs.sh
-make: [copy-mode-test-emacs.sh] Error 1 (ignored)
 sleep 1
 sh copy-mode-test-vi.sh
 make: [copy-mode-test-vi.sh] Error 1 (ignored)
```

## Development Guidelines

- All C constants/functions available under `crate::tmux_sys` module (generated by bindgen) with the same names, so most of the time there is no need to read src/tmux_sys.rs to understand what's inside.
- When porting code from C to Rust, bring over any original comments, but don't add your own.

## C-to-Rust Translation Patterns

C Function | Rust Equivalent
--- | ---
fatalx | panic!
log_debug | debug!

- Adhere to C code's unsafe behaviors. For example, if the C code doesn't check for null pointer before dereferencing, the corresponding Rust code should also not check for null pointer before dereferencing or just call `unwrap`.
- However, be flexible with types. Choose the appropriate type based on the context, not based on the C code. For example, if the C code uses an integer as a boolean, the corresponding Rust code should use a boolean type.
- Translate `&` in C bit flags to Rust `bitflags` crate's `intersects` method, not `contains`.

## Rust Coding Tips

- Prefer equivalent types from `core` to `std` e.g., use `core::ffi::c_int` instead of `std::ffi::c_int` and `core::ptr` instead of `std::ptr`.
